name: Deploy

permissions:
  id-token: write
  contents: read

inputs:
  environment:
    type: string
    required: true
  aws-region:
    type: string
    required: true
  role-session-name:
    required: false
    type: string
    default: github-actions-deployment
  deployment_role_arn:
    required: true
    type: string
  env_aws_secret_name:
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{ inputs.deployment_role_arn }}
        role-session-name: ${{ inputs.role-session-name }}
        aws-region: ${{ inputs.aws-region }}

    - name: Install node and related deps
      uses: actions/setup-node@v3
      with:
        node-version: 17.3.0

    - uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}

    - name: Install AWS CDK
      shell: bash
      run: npm install -g aws-cdk@2

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        cache: "pip"
        cache-dependency-path: |
          requirements.txt

    - name: Install python dependencies
      shell: bash
      run: |
        pip install \
          -r requirements.txt \

    - name: Get relevant environment configuration from aws secrets
      shell: bash
      run: ./scripts/sync-env.sh ${{ inputs.env_aws_secret_name }}

    - name: Deploy
      shell: bash
      run: cdk deploy --all --require-approval never
